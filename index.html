<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <link rel="manifest" href="manifest.webmanifest">
  <title>Dynamic Tintz â€” Quote Builder (PWA)</title>
  <script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
  <style>
    :root { --bg: #f1f5f9; --card:#fff; --ink:#0f172a; --muted:#475569; --accent:#2563eb; --ring:#93c5fd; --radius: 16px; }
    * { box-sizing: border-box; }
    body { margin:0; font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: var(--ink); background: var(--bg); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    h1 { font-size: 28px; margin: 0 0 4px; }
    .sub { color: var(--muted); font-size: 14px; margin: 0; }
    header { display: flex; gap: 12px; flex-direction: column; }
    @media (min-width: 640px) { header { flex-direction: row; align-items: center; justify-content: space-between; } }
    .btn { border:1px solid #e2e8f0; background:#fff; padding:10px 14px; border-radius: 16px; box-shadow: 0 1px 2px rgb(0 0 0 / 0.06); font-size:14px; cursor:pointer; }
    .btn.primary { background: var(--accent); color:#fff; border-color: var(--accent); }
    .btn.primary:hover { filter: brightness(0.95); }
    .btn:hover { box-shadow: 0 2px 6px rgb(0 0 0 / 0.08); }
    .grid { display:grid; gap:12px; }
    @media (min-width: 640px){ .grid.two { grid-template-columns: repeat(2, 1fr);} }
    @media (min-width: 1024px){ .grid.three { grid-template-columns: repeat(3, 1fr);} }
    label.block { display:block; }
    .label { font-size:12px; color: var(--muted); }
    input[type=text], input[type=number], input[type=email] { width: 100%; padding: 10px 12px; border-radius: 14px; border:1px solid #cbd5e1; background:#fff; margin-top:6px; font-size: 16px; }
    .card { background: var(--card); border:1px solid #e2e8f0; border-radius: var(--radius); box-shadow: 0 1px 2px rgb(0 0 0 / 0.06); padding: 16px; }
    table { width:100%; border-collapse: collapse; font-size:14px; }
    thead th { text-align:left; font-weight:600; color: var(--muted); background:#f1f5f9; padding:10px 8px; white-space: nowrap; }
    td { border-top:1px solid #e2e8f0; padding:8px; vertical-align: top; }
    .w-20 { width: 5rem; } .w-24 { width: 6rem; } .ta-r { text-align:right; }
    .muted { color: var(--muted); font-size: 12px; }
    .cards { display:grid; gap:12px; } @media (min-width: 1024px){ .cards { grid-template-columns: repeat(3, 1fr);} }
    .ring { outline: 2px solid #93c5fd; } .row { display:flex; align-items:center; justify-content: space-between; padding:6px 0; }
    .modal-backdrop { position:fixed; inset:0; background: rgb(0 0 0 / 0.4); display:flex; align-items:center; justify-content:center; padding: 1rem; }
    .modal { background:#fff; border-radius: 16px; width: min(900px, 100%); height: min(80vh, 100%); display:flex; flex-direction:column; overflow:hidden; }
    .modal header { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; display:flex; align-items:center; justify-content: space-between; }
    .modal .body { flex:1; overflow:auto; }
    iframe { width:100%; height:100%; border:0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#3730a3; }
    .danger { color:#b91c1c; } .link { color:#2563eb; cursor: pointer; }
    .row-inline { display:flex; gap:8px; align-items:end; flex-wrap: wrap; }
    .small { font-size: 12px; }
    .toast { position: fixed; bottom: 16px; right: 16px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:12px; opacity:0.95; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Dynamic Tintz â€” Quote Builder (PWA)</h1>
        <p class="sub">Responsive, mobile-first. Add to Home Screen on iPhone/iPad.</p>
      </div>
      <div style="display:flex; gap:8px; flex-wrap: wrap;">
        <button class="btn" id="btnSettings">Settings</button>
        <button class="btn" id="btnSaveCustomer">Save Customer</button>
        <button class="btn" id="btnCustomers">Customers</button>
        <button class="btn primary" id="btnEmail">Generate & Send</button>
        <button class="btn" id="btnOutlook">Open in Outlook</button>
      </div>
    </header>

    <section class="grid three" style="margin-top:16px;">
      <label class="block"><span class="label">Client First Name</span><input id="firstName" type="text" value="Claire" placeholder="First name"></label>
      <label class="block"><span class="label">Client Email</span><input id="clientEmail" type="email" value="claire@example.com" placeholder="email@domain.com"></label>
      <label class="block"><span class="label">Client Phone</span><input id="clientPhone" type="text" value="(555) 555-1234" placeholder="(###) ###-####"></label>
      <label class="block" style="grid-column: span 2;"><span class="label">Service Address</span><input id="serviceAddress" type="text" value="123 Commerce Dr, Dallas, TX" placeholder="Street, City, ST"></label>
      <label class="block"><span class="label">Project / Property Name</span><input id="projectName" type="text" value="Fast-Trak HQ" placeholder="e.g., Corporate HQ"></label>
      <div class="row-inline">
        <label class="block" style="min-width: 160px;"><span class="label">Job ZIP Code</span><input id="jobZip" type="text" value="" placeholder="e.g., 75001"></label>
        <label class="block" style="min-width: 160px;"><span class="label">Miles from 75409</span><input id="miles" type="number" value="12" placeholder="e.g., 42"></label>
        <button class="btn" id="btnAutoMiles" title="Calculate by ZIP">Auto-calc distance</button>
      </div>
      <div class="small muted">Auto-calc uses public ZIP geolocation (Zippopotam.us) and Haversine distance. Manual override always allowed.</div>
    </section>

    <section style="margin-top:20px;">
      <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom:8px;">
        <h2 style="margin:0; font-size:18px;">Measurements / Line Items</h2>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="btnAddRow">+ Add Row</button>
        </div>
      </div>
      <div class="card" style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Area / Room</th>
              <th>Width (in)</th>
              <th>Height (in)</th>
              <th>Qty</th>
              <th>Sq Ft</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <section style="margin-top:20px;" class="cards">
      <div class="card">
        <h3 style="margin:0 0 8px;">Totals</h3>
        <div class="row"><span>Total Sq Ft</span><span id="totalSqft" style="font-weight:600;">0.00</span></div>
        <div class="row"><span>Miles from 75409</span><span id="milesEcho" style="font-weight:600;">12</span></div>
        <div class="muted" style="margin-top:10px;">Shop minimum applies only when total â‰¤ 18 sq ft. No stacking with matrix pricing.</div>
      </div>
      <div class="card ring" id="ceramicCard">
        <h3 style="margin:0 0 2px;">ðŸŒŸ Premium Ceramic (TSER 69%+)</h3>
        <div class="muted" style="font-style:italic;">Our most advanced and most popular choice</div>
        <div class="row"><span>Original price</span><span id="cerOrig">$0.00</span></div>
        <div class="row"><span>Tier</span><span id="cerTier" class="pill">â€”</span></div>
        <div class="row"><span>Estimated discount</span><span id="cerDisc">0%</span></div>
        <div class="row"><span style="font-weight:600;">Your price</span><span id="cerFinal" style="font-weight:600;">$0.00</span></div>
        <div class="row"><span>You save</span><span id="cerSave">$0.00</span></div>
      </div>
      <div class="card" id="solarCard">
        <h3 style="margin:0 0 2px;">Solar Control (Budget-Friendly)</h3>
        <div class="muted" style="font-style:italic;">Value-driven comfort and glare reduction</div>
        <div class="row"><span>Original price</span><span id="solOrig">$0.00</span></div>
        <div class="row"><span>Tier</span><span id="solTier" class="pill">â€”</span></div>
        <div class="row"><span>Estimated discount</span><span id="solDisc">0%</span></div>
        <div class="row"><span style="font-weight:600;">Your price</span><span id="solFinal" style="font-weight:600;">$0.00</span></div>
        <div class="row"><span>You save</span><span id="solSave">$0.00</span></div>
      </div>
    </section>

    <div class="muted" style="margin-top:8px;text-align:right;">Build: v7</div>
  </div>

  <!-- Customers Modal -->
  <div id="customersModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <header>
        <div><strong>Saved Customers</strong></div>
        <button class="btn" id="closeCustomers">Close</button>
      </header>
      <div class="body" style="padding:12px 16px;">
        <div class="muted" style="margin-bottom:8px;">Tap Load to populate the app. Delete removes the record from this device only.</div>
        <input id="customerSearch" type="text" placeholder="Search saved customers..." style="width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:14px; font-size:16px; margin-bottom:10px;">
        <div id="customersList"></div>
      </div>
    </div>
  </div>

  <!-- Settings Drawer (modal) -->
  <div id="settingsModal" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <header>
        <div><strong>Settings</strong></div>
        <button class="btn" id="btnCloseSettings">Close</button>
      </header>
      <div class="body" style="padding: 12px 16px;">
        <h4>Email Sending (Microsoft 365)</h4>
        <div class="grid two" style="margin-bottom:8px;">
          <label class="block"><span class="label">Microsoft App Client ID</span><input id="msClientId" type="text" placeholder="Paste your Azure App (Application) ID"></label>
          <label class="block"><span class="label">Status</span><input id="msStatus" type="text" value="Not connected" disabled></label>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;">
          <button class="btn" id="btnMsSave">Save Config</button>
          <button class="btn" id="btnMsLogin">Sign In with Microsoft</button>
          <button class="btn" id="btnMsLogout">Sign Out</button>
          <button class="btn" id="btnTestSend">Test Send (to me)</button>
        </div>
        <div class="muted small" style="margin-bottom:16px;">Uses Microsoft Graph â†’ <code>Mail.Send</code> with delegated permission. Your credentials never leave Microsoft; tokens are cached locally.</div>

        <p class="muted">Update pricing matrices without code changes.</p>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
          <button class="btn" id="btnResetMatrices">Restore Factory Matrix</button>
        </div>

        <h4>Premium Ceramic Matrix</h4>
        <div id="ceramicMatrixEditor"></div>
        <button class="btn" id="addCerTier">+ Add Tier</button>

        <h4 style="margin-top:16px;">Solar Control Matrix</h4>
        <div id="solarMatrixEditor"></div>
        <button class="btn" id="addSolTier">+ Add Tier</button>
      </div>
    </div>
  </div>

<script>
// Utility
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));
const money = (n) => isNaN(n) ? "$0.00" : `$${n.toFixed(2)}`;
const num = (v, fb=0) => { const n = parseFloat(String(v).replace(/[^0-9.\-]/g,'')); return isNaN(n) ? fb : n; };
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

async function zipToLatLng(zip){
  const res = await fetch(`https://api.zippopotam.us/us/${encodeURIComponent(zip)}`);
  if(!res.ok) throw new Error('Invalid ZIP');
  const data = await res.json();
  const place = data.places && data.places[0];
  if(!place) throw new Error('ZIP not found');
  return { lat: parseFloat(place['latitude']), lng: parseFloat(place['longitude']) };
}
function haversineMiles(a, b){
  const R = 3958.8; const toRad = (d)=> d * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat); const dLng = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat); const lat2 = toRad(b.lat);
  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
  return 2 * R * Math.asin(Math.sqrt(h));
}

// Storage
const STORE_KEY = 'tintz.customers.v1';
const MATRIX_STORE_KEY = 'tintz.matrices.v1';
const MS_STORE_KEY = 'tintz.msconf.v1';
function getStore(){ try { return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); } catch(e){ return []; } }
function setStore(arr){ localStorage.setItem(STORE_KEY, JSON.stringify(arr)); }
function getMatrices(){ try { return JSON.parse(localStorage.getItem(MATRIX_STORE_KEY) || 'null'); } catch(e){ return null; } }
function setMatrices(obj){ localStorage.setItem(MATRIX_STORE_KEY, JSON.stringify(obj)); }
function getMsConf(){ try { return JSON.parse(localStorage.getItem(MS_STORE_KEY) || 'null'); } catch(e){ return null; } }
function setMsConf(conf){ localStorage.setItem(MS_STORE_KEY, JSON.stringify(conf)); }

// Data
let rows = [ { id: 1, area: 'Lobby North', widthIn: 48, heightIn: 72, qty: 2, notes: '' }, { id: 2, area: 'Conference A', widthIn: 60, heightIn: 60, qty: 3, notes: '' } ];
let nextRowId = 3;
const SHOP_MIN_SQFT = 18, SHOP_MIN_LOCAL = 250, SHOP_MIN_REMOTE = 350;
let ceramicMatrix = [ { min:0, max:49, rate:12.0, label:'$12 (0â€“49)' }, { min:50, max:99, rate:11.0, label:'$11 (50â€“99)' }, { min:100, max:199, rate:10.0, label:'$10 (100â€“199)' }, { min:200, max:299, rate:9.0, label:'$9 (200â€“299)' }, { min:300, max:399, rate:8.0, label:'$8 (300â€“399)' }, { min:400, max:499, rate:7.0, label:'$7 (400â€“499)' }, { min:500, max:Infinity, rate:6.5, label:'$6.50 (500+)' } ];
let solarMatrix   = [ { min:0, max:99, rate:7.5, label:'$7.50 (0â€“99)' }, { min:100, max:199, rate:6.5, label:'$6.50 (100â€“199)' }, { min:200, max:299, rate:6.0, label:'$6.00 (200â€“299)' }, { min:300, max:399, rate:5.5, label:'$5.50 (300â€“399)' }, { min:400, max:Infinity, rate:5.0, label:'$5.00 (400+)' } ];
// seed matrices if absent
(function(){ const saved = getMatrices(); if(saved && saved.ceramic && saved.solar){ ceramicMatrix = saved.ceramic; solarMatrix = saved.solar; } else { setMatrices({ ceramic: ceramicMatrix, solar: solarMatrix }); } })();

// Rendering & pricing
function rowSqft(r){ return ((num(r.widthIn)||0)*(num(r.heightIn)||0)*(num(r.qty)||0))/144; }
function totalSqft(){ return rows.reduce((a,r)=>a+rowSqft(r),0); }
function renderRows(){
  const tbody = $("#rows"); if(!tbody) return; tbody.innerHTML = "";
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input data-id="${r.id}" data-k="area" type="text" value="${escapeHtml(r.area)}" placeholder="e.g., Lobby North"></td>
      <td class="w-24"><input data-id="${r.id}" data-k="widthIn" type="number" value="${r.widthIn}"></td>
      <td class="w-24"><input data-id="${r.id}" data-k="heightIn" type="number" value="${r.heightIn}"></td>
      <td class="w-20"><input data-id="${r.id}" data-k="qty" type="number" value="${r.qty}"></td>
      <td class="w-24 ta-r">${rowSqft(r).toFixed(2)}</td>
      <td><input data-id="${r.id}" data-k="notes" type="text" value="${escapeHtml(r.notes)}" placeholder="optional"></td>
      <td class="ta-r"><span class="link" data-act="dup" data-id="${r.id}">Duplicate</span>&nbsp;|&nbsp;<span class="link danger" data-act="del" data-id="${r.id}">Delete</span></td>`;
    tbody.appendChild(tr);
  });
  tbody.oninput = (e)=>{ const t=e.target; if(!t.dataset||!t.dataset.id) return; const id=Number(t.dataset.id), key=t.dataset.k; const row=rows.find(r=>r.id===id); if(!row) return; row[key]=(key==='area'||key==='notes')?t.value:num(t.value); renderRows(); };
  tbody.onclick = (e)=>{ const t=e.target; if(!t.dataset||!t.dataset.act) return; const id=Number(t.dataset.id); if(t.dataset.act==='del'){ rows=rows.filter(r=>r.id!==id); renderRows(); } if(t.dataset.act==='dup'){ const src=rows.find(r=>r.id===id); if(src){ rows.push({...src, id: nextRowId++}); renderRows(); } } };
  updateTotalsAndPricing();
}
function findBracket(matrix, sqft){ return matrix.find(t=>sqft>=t.min && sqft<=t.max) || matrix[0]; }
function highestRate(matrix){ return matrix.length ? matrix[0].rate : 0; }
function calcFilm(matrix, sqft, miles){
  if(sqft>0 && sqft<=SHOP_MIN_SQFT){ const price=(num(miles)||0)>50?SHOP_MIN_REMOTE:SHOP_MIN_LOCAL; return { mode:'shop-min', tierLabel:`Shop Minimum (â‰¤${SHOP_MIN_SQFT} sq ft)`, original:price, finalPrice:price, savings:0, tierPct:0 }; }
  const bracket=findBracket(matrix, sqft); const rate=bracket.rate; const original=highestRate(matrix)*sqft; const finalPrice=rate*sqft; const savings=Math.max(0, original-finalPrice); const pct=original>0?Math.round((savings/original)*100):0; return { mode:'matrix', tierLabel:bracket.label, original, finalPrice, savings, tierPct:pct };
}
function updateTotalsAndPricing(){
  const sqft=totalSqft(); const totalEl=$("#totalSqft"); if(totalEl) totalEl.textContent=sqft.toFixed(2);
  const milesEl=$("#miles"); const milesVal=milesEl?num(milesEl.value,0):0; const milesEcho=$("#milesEcho"); if(milesEcho) milesEcho.textContent=milesVal;
  const cer=calcFilm(ceramicMatrix, sqft, milesVal); const sol=calcFilm(solarMatrix, sqft, milesVal);
  [["cerOrig",money(cer.original)],["cerTier",cer.tierLabel],["cerDisc",`${cer.tierPct}%`],["cerFinal",money(cer.finalPrice)],["cerSave",money(cer.savings)],
   ["solOrig",money(sol.original)],["solTier",sol.tierLabel],["solDisc",`${sol.tierPct}%`],["solFinal",money(sol.finalPrice)],["solSave",money(sol.savings)]].forEach(([id,val])=>{ const el=document.getElementById(id); if(el) el.textContent=val; });
}
function buildEmailHtml(){
  const projectName=($("#projectName")?.value||"").trim(); const firstName=($("#firstName")?.value||"").trim(); const serviceAddress=($("#serviceAddress")?.value||"").trim();
  const sqft=totalSqft(); const miles=$("#miles")?num($("#miles").value,0):0; const cer=calcFilm(ceramicMatrix, sqft, miles); const sol=calcFilm(solarMatrix, sqft, miles);
  const cerLine=cer.mode==='shop-min'?`- <strong>Tier:</strong> ${escapeHtml(cer.tierLabel)}`:`- <strong>Discount tier applied:</strong> ${escapeHtml(cer.tierLabel)} (${cer.tierPct}%)`;
  const solLine=sol.mode==='shop-min'?`- <strong>Tier:</strong> ${escapeHtml(sol.tierLabel)}`:`- <strong>Discount tier applied:</strong> ${escapeHtml(sol.tierLabel)} (${sol.tierPct}%)`;
  return `<!DOCTYPE html><html><body style="font-family: Arial, sans-serif; color:#333; line-height:1.6; max-width:700px;">
    <p><strong>Subject:</strong> Your Window Film Proposal â€” ${escapeHtml(projectName)}</p>
    <p>${escapeHtml(firstName)},</p>
    <p>Thank you for the opportunity to support ${escapeHtml(serviceAddress)}. Based on the verified measurements, please find two aligned options so you can select the performance profile and budget that best fit your goals.</p>
    <p><strong>Total Glass Area</strong><br>- <strong>${sqft.toFixed(2)} sq ft</strong></p>

    <div style="background:#f8f8f8; padding:16px; border-left:4px solid #0d6efd; margin:20px 0;">
      <h2 style="margin:0 0 6px 0;">ðŸŒŸ Option A â€” Premium Ceramic Window Film (TSER 69%+)</h2>
      <em>Our most advanced and most popular choice, combining performance and long-term value.</em>
      <p style="margin:10px 0 10px 0;">Engineered to materially reduce solar heat gain and glare while maintaining optical clarity. This film delivers a <strong>Total Solar Energy Rejection of 69%+</strong>, helps stabilize interior temperatures, supports HVAC efficiency, and <strong>enhances the glass to elevate the exterior aesthetic.</strong></p>
      <p style="margin:8px 0 0 0;">- <strong>Original price:</strong> ${money(cer.original)}<br>
         ${cerLine}<br>
         - <strong>Your price:</strong> <strong>${money(cer.finalPrice)}</strong><br>
         - <strong>You save:</strong> ${money(cer.savings)}</p>
      <p style="margin:14px 0 0 0;"><strong>Warranty</strong><br>
         - Residential: Lifetime warranty on film and workmanship<br>
         - Commercial: 12-year warranty on film and workmanship</p>
    </div>

    <div style="background:#f8f8f8; padding:16px; border-left:4px solid #444; margin:20px 0;">
      <h2 style="margin:0 0 6px 0;">Option B â€” Solar Control Film (Budget-Friendly)</h2>
      <p style="margin:0 0 10px 0;">A cost-optimized solution that reduces heat and glare compared to untreated glass, offering a clean, neutral appearance. While designed for value, it is still installed to the same professional standards, ensuring durability and customer satisfaction.</p>
      <p style="margin:8px 0 0 0;">- <strong>Original price:</strong> ${money(sol.original)}<br>
         ${solLine}<br>
         - <strong>Your price:</strong> <strong>${money(sol.finalPrice)}</strong><br>
         - <strong>You save:</strong> ${money(sol.savings)}</p>
      <p style="margin:14px 0 0 0;"><strong>Warranty</strong><br>
         This film comes with <strong>limited coverage supported by our professional installation team</strong>, giving you added peace of mind knowing that youâ€™re in good hands.</p>
    </div>

    <h2 style="margin:16px 0 6px 0;">Why Choose Us</h2>
    <p>We are <strong>Veteran owned and operated</strong> and consistently recognized as a <strong>5-star rated provider</strong>, trusted by homeowners and businesses alike. Our team is committed to delivering a seamless experience and results that elevate comfort, performance, and aesthetic appeal.</p>
    <p>Best regards,</p>
  </body></html>`;
}

// Settings editor
function renderMatrixEditor(container, matrix, onChange){
  container.innerHTML = ''; matrix.forEach((t,i)=>{
    const row = document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='repeat(12, 1fr)'; row.style.gap='8px'; row.style.alignItems='end'; row.style.marginBottom='8px';
    row.innerHTML = `<label class="block" style="grid-column: span 3;"><span class="label">Min sq ft</span><input data-i="${i}" data-k="min" type="number" value="${t.min}"></label>
      <label class="block" style="grid-column: span 3;"><span class="label">Max sq ft</span><input data-i="${i}" data-k="max" type="text" value="${t.max===Infinity?'Infinity':t.max}"></label>
      <label class="block" style="grid-column: span 3;"><span class="label">Rate $/sq ft</span><input data-i="${i}" data-k="rate" type="number" step="0.01" value="${t.rate}"></label>
      <label class="block" style="grid-column: span 3;"><span class="label">Tier label</span><input data-i="${i}" data-k="label" type="text" value="${escapeHtml(t.label)}"></label>
      <div style="grid-column: 12 / span 1; justify-self: end;"><span class="link danger" data-i="${i}" data-act="remove">Remove</span></div>`;
    container.appendChild(row);
  });
  container.oninput=(e)=>{ const t=e.target; const i=Number(t.dataset.i); const k=t.dataset.k; if(isNaN(i)||!k) return;
    const patch={}; if(k==='max'){ patch[k]=t.value==='Infinity'?Infinity:num(t.value);} else if(k==='label'){patch[k]=t.value;} else {patch[k]=num(t.value);} matrix[i]={...matrix[i],...patch}; onChange(matrix);
  };
  container.onclick=(e)=>{ const t=e.target; if(t.dataset.act!=='remove') return; const i=Number(t.dataset.i); matrix.splice(i,1); onChange(matrix); };
}
function openSettings(){
  const modal=$("#settingsModal");
  renderMatrixEditor($("#ceramicMatrixEditor"), ceramicMatrix, (m)=>{ ceramicMatrix=[...m]; setMatrices({ceramic:ceramicMatrix, solar:solarMatrix}); updateTotalsAndPricing(); openSettings(); });
  renderMatrixEditor($("#solarMatrixEditor"), solarMatrix, (m)=>{ solarMatrix=[...m]; setMatrices({ceramic:ceramicMatrix, solar:solarMatrix}); updateTotalsAndPricing(); openSettings(); });
  $("#addCerTier").onclick=()=>{ ceramicMatrix.push({min:0,max:0,rate:0,label:'Custom'}); setMatrices({ceramic:ceramicMatrix, solar:solarMatrix}); openSettings(); };
  $("#addSolTier").onclick=()=>{ solarMatrix.push({min:0,max:0,rate:0,label:'Custom'}); setMatrices({ceramic:ceramicMatrix, solar:solarMatrix}); openSettings(); };
  $("#btnResetMatrices").onclick=()=>{ ceramicMatrix=[ { min:0, max:49, rate:12.0, label:'$12 (0â€“49)' }, { min:50, max:99, rate:11.0, label:'$11 (50â€“99)' }, { min:100, max:199, rate:10.0, label:'$10 (100â€“199)' }, { min:200, max:299, rate:9.0, label:'$9 (200â€“299)' }, { min:300, max:399, rate:8.0, label:'$8 (300â€“399)' }, { min:400, max:499, rate:7.0, label:'$7 (400â€“499)' }, { min:500, max:Infinity, rate:6.5, label:'$6.50 (500+)' } ]; solarMatrix=[ { min:0, max:99, rate:7.5, label:'$7.50 (0â€“99)' }, { min:100, max:199, rate:6.5, label:'$6.50 (100â€“199)' }, { min:200, max:299, rate:6.0, label:'$6.00 (200â€“299)' }, { min:300, max:399, rate:5.5, label:'$5.50 (300â€“399)' }, { min:400, max:Infinity, rate:5.0, label:'$5.00 (400+)' } ]; setMatrices({ceramic:ceramicMatrix, solar:solarMatrix}); updateTotalsAndPricing(); openSettings(); };
  // MSAL config
  const cid = document.getElementById('msClientId'); const status = document.getElementById('msStatus');
  const conf = getMsConf() || { clientId: '', redirectUri: window.location.origin + window.location.pathname };
  if(cid) cid.value = conf.clientId || '';
  function setStatus(text){ if(status) status.value = text; }
  let msalApp = null, msAccount = null;
  function msInit(){
    if(!conf.clientId){ setStatus('Not connected'); return; }
    try{
      msalApp = new msal.PublicClientApplication({
        auth: { clientId: conf.clientId, authority: 'https://login.microsoftonline.com/common', redirectUri: conf.redirectUri || window.location.origin + window.location.pathname },
        cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false }
      });
      msalApp.handleRedirectPromise().then((res)=>{
        if(res && res.account){ msAccount = res.account; setStatus('Connected: ' + (msAccount.username||'Account')); }
        else { const a = msalApp.getAllAccounts(); if(a.length){ msAccount=a[0]; setStatus('Connected: ' + (msAccount.username||'Account')); } else { setStatus('Not connected'); } }
      }).catch(()=> setStatus('Auth error'));
    }catch(e){ setStatus('MSAL init error'); }
  }
  msInit();
  const bSave = document.getElementById('btnMsSave'); if(bSave){ bSave.onclick = ()=>{ const updated = { clientId: document.getElementById('msClientId').value.trim(), redirectUri: window.location.origin + window.location.pathname }; setMsConf(updated); alert('Saved.'); location.reload(); }; }
  const bLogin = document.getElementById('btnMsLogin'); if(bLogin){ bLogin.onclick = ()=>{ if(!msalApp){ alert('Save Client ID first.'); return; } msalApp.loginRedirect({ scopes: ['User.Read','Mail.Send'] }); }; }
  const bLogout = document.getElementById('btnMsLogout'); if(bLogout){ bLogout.onclick = ()=>{ if(!msalApp || !msAccount){ alert('Not signed in.'); return; } msalApp.logoutRedirect({ account: msAccount }); }; }
  const bTest = document.getElementById('btnTestSend'); if(bTest){ bTest.onclick = async ()=>{
      if(!msalApp){ alert('Save Client ID first.'); return; }
      const a = msalApp.getAllAccounts(); if(!a.length){ alert('Sign in first.'); return; }
      const token = await msalApp.acquireTokenSilent({ account: a[0], scopes: ['Mail.Send'] }).catch(()=>null);
      if(!token){ msalApp.acquireTokenRedirect({ account: a[0], scopes: ['Mail.Send'] }); return; }
      const me = a[0].username;
      const html = buildEmailHtml();
      const payload = { message: { subject: 'Test â€” Dynamic Tintz PWA', body: { contentType:'HTML', content: html }, toRecipients: [{ emailAddress:{ address: me }}] }, saveToSentItems: true };
      const res = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', { method:'POST', headers:{ 'Authorization':'Bearer '+token.accessToken, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      if(res.ok) alert('Test sent to ' + me); else alert('Graph send failed');
    }; }
  $("#btnCloseSettings").onclick=()=>{ modal.style.display='none'; };
}

// Email send
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 2200); }
function openOutlookCompose(){
  const to = ($("#clientEmail")?.value || '').trim();
  const subject = `Your Window Film Proposal â€” ${($("#projectName")?.value || '').trim()}`;
  const html = buildEmailHtml();
  const enc = encodeURIComponent;
  const plain = html.replace(/<[^>]+>/g,''); // fallback uses plain text
  const outlook = `ms-outlook://compose?to=${enc(to)}&subject=${enc(subject)}&body=${enc(plain)}`;
  const mailto = `mailto:${enc(to)}?subject=${enc(subject)}&body=${enc(plain)}`;
  window.location.href = outlook; setTimeout(()=>{ window.location.href = mailto; }, 700);
}

// Bindings
document.addEventListener('DOMContentLoaded', ()=>{
  const bind=(id,fn)=>{ const el=document.getElementById(id); if(!el) return; el.addEventListener('click',fn,false); el.addEventListener('touchend',(e)=>{e.preventDefault(); fn(e);}, false); };
  bind('btnAddRow', ()=>{ rows.push({ id: nextRowId++, area:'', widthIn:0, heightIn:0, qty:1, notes:'' }); renderRows(); });
  bind('btnSettings', openSettings);
  bind('btnOutlook', openOutlookCompose);
  bind('btnSaveCustomer', ()=>{ const state={ firstName: $("#firstName")?.value || "", clientEmail: $("#clientEmail")?.value || "", clientPhone: $("#clientPhone")?.value || "", serviceAddress: $("#serviceAddress")?.value || "", projectName: $("#projectName")?.value || "", jobZip: $("#jobZip")?.value || "", miles: $("#miles")?.value || "0", rows: rows, ceramicMatrix: ceramicMatrix, solarMatrix: solarMatrix }; const suggested=(state.firstName||'Customer')+' â€” '+(state.projectName||'Project'); const label=prompt('Save as:', suggested); if(label===null) return; const rec={...state,label,createdAt:Date.now()}; const data=getStore(); data.unshift(rec); setStore(data); toast('Saved to this device.'); });
  bind('btnCustomers', ()=>{
    const modal = $("#customersModal"); const list = $("#customersList"); const search = $("#customerSearch");
    function render(filterText){ const data=getStore(); list.innerHTML=''; const f=(filterText||'').toLowerCase().trim(); const filtered = !f ? data : data.filter(rec => { const hay=[rec.label,rec.firstName,rec.projectName,rec.clientEmail,rec.serviceAddress,rec.jobZip].filter(Boolean).join(' ').toLowerCase(); return hay.indexOf(f)!==-1; }); if(!filtered.length){ list.innerHTML='<div class=\"muted\">No matching customers.</div>'; return; } filtered.forEach((rec, idx)=>{ const div=document.createElement('div'); div.className='card'; const created=rec.createdAt?new Date(rec.createdAt).toLocaleString():''; div.innerHTML=`<div style=\"display:flex; justify-content:space-between; align-items:start; gap:8px;\"><div><div><strong>${escapeHtml(rec.label || (rec.firstName||'') + ' â€” ' + (rec.projectName||''))}</strong></div><div class=\"muted small\">${escapeHtml(rec.clientEmail || '')} â€¢ ${escapeHtml(rec.projectName || '')}</div><div class=\"muted small\">${escapeHtml(rec.serviceAddress || '')}</div><div class=\"muted small\">Saved: ${escapeHtml(created)}</div></div><div style=\"display:flex; gap:8px;\"><button class=\"btn\" data-idx=\"${idx}\" data-act=\"load\">Load</button><button class=\"btn\" data-idx=\"${idx}\" data-act=\"delete\">Delete</button></div></div>`; list.appendChild(div); }); }
    render(''); if (search){ search.oninput = ()=> render(search.value); }
    list.onclick = (e)=>{ const t=e.target; if(!t.dataset||t.dataset.idx===undefined) return; const idx=Number(t.dataset.idx); const data=getStore(); if(t.dataset.act==='load'){ const rec=data[idx]; $("#firstName").value=rec.firstName||''; $("#clientEmail").value=rec.clientEmail||''; $("#clientPhone").value=rec.clientPhone||''; $("#serviceAddress").value=rec.serviceAddress||''; $("#projectName").value=rec.projectName||''; $("#jobZip").value=rec.jobZip||''; $("#miles").value=rec.miles||'0'; rows=Array.isArray(rec.rows)?rec.rows.map(r=>({...r})):[]; nextRowId=rows.reduce((m,r)=>Math.max(m,r.id||0),0)+1; ceramicMatrix=Array.isArray(rec.ceramicMatrix)?rec.ceramicMatrix.map(t=>({...t})):ceramicMatrix; solarMatrix=Array.isArray(rec.solarMatrix)?rec.solarMatrix.map(t=>({...t})):solarMatrix; renderRows(); toast('Customer loaded.'); } else if(t.dataset.act==='delete'){ if(confirm('Delete this saved customer from this device?')){ data.splice(idx,1); setStore(data); render(search?search.value:''); } } };
    document.getElementById('closeCustomers').onclick = ()=>{ modal.style.display='none'; };
    modal.style.display='flex';
  });
  const milesEl=document.getElementById('miles'); if(milesEl){ milesEl.addEventListener('input', updateTotalsAndPricing); milesEl.addEventListener('change', updateTotalsAndPricing); }
  const autoBtn=document.getElementById('btnAutoMiles'); if(autoBtn){ autoBtn.addEventListener('click', async ()=>{ const btn=document.getElementById('btnAutoMiles'); const jobZip=document.getElementById('jobZip').value.trim(); if(!/^\d{5}$/.test(jobZip)){ alert('Enter a valid 5-digit Job ZIP.'); return; } btn.disabled=true; const oldText=btn.textContent; btn.textContent='Calculatingâ€¦'; try{ const [shop,job]=await Promise.all([ zipToLatLng('75409'), zipToLatLng(jobZip) ]); const miles=haversineMiles(shop,job); const rounded=Math.round(miles); document.getElementById('miles').value=String(rounded); updateTotalsAndPricing(); }catch(e){ alert('Could not resolve ZIP distance. You can enter miles manually.'); } finally{ btn.disabled=false; btn.textContent=oldText; } }, false); autoBtn.addEventListener('touchend', (e)=>{ e.preventDefault(); autoBtn.click(); }, false); }
  bind('btnEmail', async ()=>{
    const to = ($("#clientEmail")?.value || '').trim();
    if(!to){ alert('Enter a Client Email first.'); return; }
    const subject = `Your Window Film Proposal â€” ${($("#projectName")?.value || '').trim()}`;
    const html = buildEmailHtml();
    // Try Microsoft Graph first if configured
    try{
      const conf = getMsConf(); if(conf && conf.clientId){\n        const app = new msal.PublicClientApplication({ auth: { clientId: conf.clientId, authority: 'https://login.microsoftonline.com/common', redirectUri: conf.redirectUri || window.location.origin + window.location.pathname }, cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false } });\n        const accts = app.getAllAccounts(); if(!accts.length){ toast('Sign in via Settings first. Falling back to Outlook compose.'); throw new Error('noaccount'); }\n        const token = await app.acquireTokenSilent({ account: accts[0], scopes: ['Mail.Send'] }).catch(()=>null);\n        if(!token){ app.acquireTokenRedirect({ account: accts[0], scopes: ['Mail.Send'] }); return; }\n        const payload = { message: { subject: subject, body: { contentType:'HTML', content: html }, toRecipients: [{ emailAddress:{ address: to }}] }, saveToSentItems: true };\n        const res = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', { method:'POST', headers:{ 'Authorization':'Bearer '+token.accessToken, 'Content-Type':'application/json' }, body: JSON.stringify(payload) });\n        if(res.ok){ toast('Email sent via Microsoft 365.'); return; } else { const txt = await res.text(); console.log(txt); toast('Graph send failed. Using Outlook.'); throw new Error('graphfail'); }\n      }\n    }catch(e){ /* fallthrough to Outlook */ }\n    // Fallback: Outlook compose (user taps Send)\n    const enc = encodeURIComponent; const plain = html.replace(/<[^>]+>/g,''); const outlook = `ms-outlook://compose?to=${enc(to)}&subject=${enc(subject)}&body=${enc(plain)}`; const mailto = `mailto:${enc(to)}?subject=${enc(subject)}&body=${enc(plain)}`; window.location.href = outlook; setTimeout(()=>{ window.location.href = mailto; }, 700);\n  });
  renderRows();
});

// SW disabled by default
const ENABLE_OFFLINE=false;
if (ENABLE_OFFLINE && 'serviceWorker' in navigator) { window.addEventListener('load', ()=>{ navigator.serviceWorker.register('sw.js', { scope: './' }); }); }
</script>
</body>
</html>
